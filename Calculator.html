<!DOCTYPE html>
<html>
<head>
	<title>Calculator</title>
	<style>
		td {
			vertical-align: top;
		}
	</style>
</head>
<body>

	<table border=1>
		<tr>
			<td>

				<textarea id="input" rows="20" cols="50">
3
2 ^ 8
(12 % 7) * (3 + 2)
19 / -9

hoursPerDay = 24
minutesPerHour = 60
minutesPerDay = minutesPerHour * hoursPerDay
minutesPerDay
minutesPerDay * 60

toDegrees(radians) = radians * 180 / pi
toDegrees(2 * pi)

cylinderVolume(r, h) = pi * r ^ 2 * h
cylinderVolume(2, 4)

PrettyPrint(1,2)
				</textarea>
			<td>
				<button id="calculate">Calculate</button><br>
				<button id="prettyprint">PrettyPrint</button><br>
				<button id="clear">Clear</button><br>
				<button id="prettyprintselection">PrettyPrint Selection</button>
			<td>
				<pre id="output" style="min-width:100px; border: 1px solid black"></pre>
		<tr>
	</table>

<script src="lexer.js"></script>
<script src="parser.js"></script>
<script src="evaluator.js"></script>
<script>
	function getArgs(func) {
		var s;
		s = func.toString();
		s = s.substring(10, s.indexOf(")"));
		s = s.replace(/ /g, "");
		return s.split(",");
	}
	
	/*
		function(id, leftBindingPower, rightBindingPower, leftDenotation) {
			
			eval("console.log(\"infix:\", id, leftBindingPower, rightBindingPower, leftDenotation, getArgs(parser).join('a'));")
			oldinfix(id, leftBindingPower, rightBindingPower, leftDenotation);
		}
	*/
	
	function toSource(func) {
		var src = func.toSource();
		//console.log(src);
		return src.substring(src.indexOf("{")+1, src.length - 2);
	}
	
	function hookLog(obj, oldFunc, funcname) {
		var tmp;
		tmp += "a = function (obj, oldFunc, funcname)";
		tmp += "{";
			//tmp += "console.log(\"oldFunc:\", oldFunc, \"parser:\", obj);";
		
			var args = getArgs(oldFunc);
			tmp += "return function (" + args.join(",") + ")";
			tmp += "{";
				tmp += toSource(function() {
					var a = [funcname + ">"];
					for (var i=0; i<args.length; i++) {
						a.push(args[i], eval(args[i]));
					}
					console.log.apply(null, a);
					//oldFunc.apply(obj, args);
				});
				tmp += "return oldFunc.bind(obj)(" + args.join(",") + ");";
				
			tmp += "}";
		
		tmp += "}";
		return eval(tmp)(obj, oldFunc, funcname);
	}
	
	var calculate = function (input) {
		var tokens = lex(input);
		//var parseTree = parse(tokens);
		parser = new Parser(tokens);
		
		//parser.infix = hookLog(parser, parser.infix, "infix");
		//parser.expression = hookLog(parser, parser.expression, "expression");

		parser.init();

		//comma = parser.symbols["="];
		//comma.leftDenotation = hookLog(comma, comma.leftDenotation, "Equal sign");
		
		parser.parse();
		var output = evaluate(parser.parseTree);
		return output;
	};

	function clear() {
		document.getElementById("output").innerHTML = "";
	}
	function print(msg) {
		document.getElementById("output").innerHTML += msg + "\n";
	}
	
	document.getElementById("calculate").onclick = function () {
		var input = document.getElementById("input").value;
		output = calculate(input);
		print("\nStatement evaluations: \n" + output);
	};
	document.getElementById("clear").onclick = function () {
		clear()
	};
	document.getElementById("prettyprint").onclick = function () {
		var input = document.getElementById("input").value;
		output = calculate(input);
		
		var tokens = lex(input);
		parser = new Parser(tokens);
		parser.init();
		parser.parse();
		
		PrettyPrint(parser.parseTree, 0);
	};
	document.getElementById("prettyprintselection").onclick = function () {
		textarea = document.getElementById("input");
		s = textarea.selectionStart;
		e = textarea.selectionEnd;
		var input = textarea.value.substring(s,e)
		print("Selection: <div class=selection>" + input + "</div>");
		
		output = calculate(input);
		
		var tokens = lex(input);
		parser = new Parser(tokens);
		parser.init();
		parser.parse();
		PrettyPrint(parser.parseTree, 0);
	};
</script>

<canvas id="myCanvas" width="578" height="200"></canvas>
<script>
var canvas = document.getElementById('myCanvas');
var context = canvas.getContext('2d');

function line(from_left, from_top, to_left, to_top) {
	context.beginPath();
	context.moveTo(from_left, from_top);
	context.lineTo(to_left, to_top);
	context.stroke();
}

function text(text, left, top) {
	context.font = '20pt Calibri';
	context.fillStyle = 'blue';
	context.fillText(text, left, top);
}

text("100 10", 100, 10);
text("10 100", 10, 100);
line(100, 10, 10, 100);
</script>

<button onclick="context.clearRect(0, 0, canvas.width, canvas.height);">Clear Canvas</button>
		

	</body>
</html>
